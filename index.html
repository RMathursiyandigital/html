<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CuraTrail • Sessions 1–3 Tester (Unified API)</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--sub:#334155;--text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--danger:#ef4444;--warn:#f59e0b;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#020617,#0b1222 55%,#0f172a);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1140px;margin:24px auto;padding:16px}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1f2937;gap:12px;flex-wrap:wrap}
  header h1{font-size:16px;margin:0;letter-spacing:.3px}
  header .tag{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .controls .grp{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:12px}
  .controls input, .controls select{height:30px;border-radius:8px;border:1px solid #1f2937;background:#0f172a;color:#e5e7eb;padding:0 8px}
  .controls input#apiBase{width:260px}
  .controls input[type="text"]{width:160px}
  .controls select#sessionNum{width:90px}
  button{border:1px solid #1f2937;background:#0f172a;color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:#16a34a;border-color:#16a34a}
  button.warn{background:rgba(245,158,11,.15);border-color:#f59e0b}
  button.ghost{background:transparent}
  button:disabled{opacity:.6;cursor:not-allowed}
  main{display:grid;grid-template-columns:1fr 360px}
  @media (max-width:1100px){main{grid-template-columns:1fr}}
  .chat{min-height:420px;max-height:70vh;overflow:auto;padding:16px;scroll-behavior:smooth}
  .bubble{max-width:78%;margin:8px 0;padding:10px 12px;border-radius:12px;border:1px solid #1f2937;white-space:pre-wrap;position:relative}
  .user{margin-left:auto;background:#0a223a}
  .assistant{background:#0b1f1a;border-color:#14392c}
  .system{background:#16181d;border-style:dashed;color:#cbd5e1}
  .danger{background:rgba(239,68,68,.12);border-color:#ef4444}
  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid #1f2937;background:#0a0f1a;align-items:flex-start;flex-wrap:wrap}
  .composer textarea{flex:1;min-height:44px;max-height:140px;resize:vertical;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:10px}
  .quickRow{display:flex;gap:8px;align-items:center}
  aside{border-left:1px solid #1f2937;background:#0a0f1a}
  .aside-inner{padding:14px}
  .kv{display:grid;grid-template-columns:130px 1fr;gap:6px 10px;font-size:12px;color:#cbd5e1}
  .kv span{color:#94a3b8}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #1f2937}
  .pill.warn{background:rgba(245,158,11,.12);border-color:#f59e0b;color:#fbbf24}
  .pill.cap{background:rgba(239,68,68,.12);border-color:#ef4444;color:#fca5a5}
  .pill.done{background:rgba(34,197,94,.14);border-color:#22c55e;color:#86efac}
  .timer{font-variant-numeric:tabular-nums}
  .event{font-size:12px;color:#94a3b8;margin:6px 0}
  .hint{font-size:12px;color:#94a3b8;margin:6px 0 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .videoBox,.pvqBox{margin:10px 16px 0;padding:10px;border:1px dashed #1f2937;border-radius:10px;background:#0b1220}
  .pvqQ{margin-top:6px;padding:10px;border:1px solid #1f2937;border-radius:10px;background:#0f172a}
  .pvqNav{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .link{color:#60a5fa;text-decoration:none}
  .drawer{position:fixed;right:16px;top:86px;width:360px;max-width:95vw;background:#0b1220;border:1px solid #1f2937;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:50}
  .drawer header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #1f2937}
  .drawer .body{padding:12px}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .field input, .field select, .field textarea{border:1px solid #1f2937;background:#0f172a;color:#e5e7eb;border-radius:8px;padding:8px}
  .row-space{display:flex;gap:8px}

  /* --- Table rendering inside assistant bubbles --- */
  .tableWrap{margin:8px 0 0; overflow:auto;}
  .tableWrap table{width:100%; border-collapse:collapse; font-size:13px;}
  .tableWrap th,.tableWrap td{border:1px solid #1f2937; padding:6px 8px; text-align:left; vertical-align:top;}
  .tableWrap th{background:#0f172a; color:#cbd5e1; position:sticky; top:0;}
  .tableWrap tr:nth-child(even) td{background:#0b1220;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div>
        <h1>CuraTrail — Sessions 1–3 Tester</h1>
        <div class="tag">Unified API • Persona-aware</div>
      </div>
      <div class="controls">
        <div class="grp"><span>API</span><input id="apiBase" type="url" value="https://https://ai-conversation.orangebeach-0cb68c5b.westus3.azurecontainerapps.io/v1" /></div>
        <div class="grp"><span>Email</span><input id="emailId" type="email" placeholder="you@example.com" /></div>
        <div class="grp"><span>Name</span><input id="displayName" type="text" placeholder="Your name" /></div>
        <div class="grp"><span>Session #</span>
          <select id="sessionNum">
            <option value="1">1 — 1) Personalized GAD Profile Mapping</option>
            <option value="2">2 — 2) Your Care Plan & Goal Setting</option>
            <option value="3">3 — 3) Challenging Negative Thoughts</option>
          </select>
        </div>
        <button id="btnProfile" class="ghost">Open Profile</button>
        <button id="btnStart" class="primary" disabled>Start Session (Step 2)</button>
        <button id="btnFreshAttempt" class="warn" style="display:none">Start Fresh Attempt</button>
        <button id="btnRecap" disabled>Finalize Recap</button>
      </div>
    </header>

    <main>
      <section>
        <!-- Step 1 — Watch video BEFORE creating a session (server gate) -->
        <div id="preVideoPanel" class="videoBox">
          <div class="row">
            <strong class="step">Step 1:</strong>
            <div>
              <div><strong>Watch the session intro video in the app</strong></div>
              <div id="preVideoTitle" class="hint">Intro</div>
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="btnPreVideoDone" class="primary">I watched the video</button>
            <span id="preVideoStatus" class="hint">Required before starting the session.</span>
          </div>
        </div>

        <!-- Informational: shows that the pre-video gate is recorded/consumed -->
        <div id="videoPanel" class="videoBox" style="display:none">
          <div class="row"><strong>Video Gate</strong> <span id="videoTitle" class="hint">Recorded with /videos/complete</span></div>
          <div class="row" style="margin-top:6px">
            <span id="videoStatus" class="hint">—</span>
          </div>
        </div>

        <!-- Session Briefing (static, avoids 404 noise) -->
        <div id="briefing" class="videoBox" style="display:none">
          <div class="row"><strong>Session Briefing</strong></div>
          <div id="briefingBody" class="hint">Loading…</div>
        </div>

        <!-- PVQ panel (unified) -->
        <div id="pvqPanel" class="pvqBox" style="display:none">
          <div class="row"><strong>Post-Video Questions</strong><span id="pvqProg" class="hint">—</span></div>
          <div id="pvqQ" class="pvqQ">—</div>
          <textarea id="pvqAns" placeholder="Type your answer" style="width:100%;margin-top:8px;min-height:60px;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:8px"></textarea>
          <div class="pvqNav">
            <button id="pvqPrev">Previous</button>
            <button id="pvqNext" class="primary">Next</button>
          </div>
        </div>

        <div id="chat" class="chat"></div>

        <div class="composer">
          <textarea id="input" placeholder="Answer here in your own words…" disabled></textarea>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="btnSend" disabled>Send</button>
            <a id="recapPdfLink" class="link" href="#" style="display:none" target="_blank">⬇ Download Recap PDF</a>
          </div>
          <!-- Confirm row injected here when needed -->
        </div>
      </section>

      <aside>
        <div class="aside-inner">
          <h3 style="margin:4px 0 10px 0">Session</h3>
          <div class="kv">
            <span>User</span><div id="emailVal">—</div>
            <span>Name</span><div id="nameVal">—</div>
            <span>Session ID</span><code id="sid">—</code>
            <span>Status</span><div id="status"><span class="pill">—</span></div>
            <span>Elapsed</span><div class="timer" id="elapsed">—</div>
            <span>Warn @25m</span><div id="warn">—</div>
            <span>Hard cap @30m</span><div id="cap">—</div>
            <span>Video</span><div id="videoDoneVal">—</div>
          </div>
          <hr style="border-color:#1f2937;margin:12px 0" />
          <h3 style="margin:4px 0 8px 0">Persona</h3>
          <div class="kv" id="personaKv">
            <span>Role</span><div id="pRole">—</div>
            <span>Occupation</span><div id="pOcc">—</div>
            <span>Experience</span><div id="pExp">—</div>
            <span>Pace</span><div id="pPace">—</div>
            <span>Tone</span><div id="pTone">—</div>
            <span>Jargon OK</span><div id="pJargon">—</div>
          </div>
          <hr style="border-color:#1f2937;margin:12px 0" />
          <h3 style="margin:4px 0 8px 0">Events</h3>
          <div id="events" style="font-size:12px;color:#a3b8d1"></div>
        </div>
      </aside>
    </main>
  </div>
</div>

<div id="drawer" class="drawer">
  <header>
    <strong>User Profile</strong>
    <button id="btnCloseProfile">✕</button>
  </header>
  <div class="body">
    <div class="field">
      <label>Role label</label>
      <select id="roleLabel">
        <option value="">— Select —</option>
        <option>doctor</option>
        <option>nurse</option>
        <option>clinician</option>
        <option>student</option>
        <option>parent</option>
        <option>engineer</option>
        <option>researcher</option>
        <option>teacher</option>
        <option>other</option>
      </select>
    </div>
    <div class="field">
      <label>Occupation (free text)</label>
      <input id="occupation" type="text" placeholder="Emergency physician, software engineer, etc." />
    </div>
    <div class="field">
      <label>Experience summary</label>
      <input id="experience" type="text" placeholder="e.g., 10 years in ICU" />
    </div>
    <div class="row-space">
      <div class="field" style="flex:1">
        <label>Pace</label>
        <select id="prefPace">
          <option value="">auto</option>
          <option value="standard">standard</option>
          <option value="concise">concise</option>
        </select>
      </div>
      <div class="field" style="flex:1">
        <label>Tone</label>
        <select id="prefTone">
          <option value="">auto</option>
          <option value="warm_plain">warm_plain</option>
          <option value="professional_warm">professional_warm</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label style="gap:10px"><input id="prefJargon" type="checkbox" /> Allow light jargon with plain-language gloss</label>
    </div>
    <div class="row-space" style="justify-content:flex-end;margin-top:6px">
      <button id="btnProfileDefaults" class="ghost">Apply Role Defaults</button>
      <button id="btnSaveProfile" class="primary">Save Profile</button>
    </div>
  </div>
</div>

<script>
/* ---------- Elements ---------- */
let API = document.getElementById("apiBase").value.replace(/\/$/, "");
const chatEl        = document.getElementById("chat");
const inputEl       = document.getElementById("input");
const btnSend       = document.getElementById("btnSend");
const btnStart      = document.getElementById("btnStart");
const btnRecap      = document.getElementById("btnRecap");
const btnFreshAttempt = document.getElementById("btnFreshAttempt");
const sidEl         = document.getElementById("sid");
const statusEl      = document.getElementById("status");
const elapsedEl     = document.getElementById("elapsed");
const warnEl        = document.getElementById("warn");
const capEl         = document.getElementById("cap");
const eventsEl      = document.getElementById("events");
const sessionNumEl  = document.getElementById("sessionNum");
const emailInput    = document.getElementById("emailId");
const nameInput     = document.getElementById("displayName");
const emailValEl    = document.getElementById("emailVal");
const nameValEl     = document.getElementById("nameVal");

const videoPanel    = document.getElementById("videoPanel");
const videoTitle    = document.getElementById("videoTitle");
const videoStatus   = document.getElementById("videoStatus");
const videoDoneVal  = document.getElementById("videoDoneVal");

const pvqPanel      = document.getElementById("pvqPanel");
const pvqProg       = document.getElementById("pvqProg");
const pvqQEl        = document.getElementById("pvqQ");
const pvqAns        = document.getElementById("pvqAns");
const pvqPrev       = document.getElementById("pvqPrev");
const pvqNext       = document.getElementById("pvqNext");

const personaEls = {role:document.getElementById("pRole"),occ:document.getElementById("pOcc"),exp:document.getElementById("pExp"),pace:document.getElementById("pPace"),tone:document.getElementById("pTone"),jargon:document.getElementById("pJargon")};
const drawer = document.getElementById("drawer");
const btnProfile = document.getElementById("btnProfile");
const btnCloseProfile = document.getElementById("btnCloseProfile");
const btnSaveProfile = document.getElementById("btnSaveProfile");
const btnProfileDefaults = document.getElementById("btnProfileDefaults");
const roleSel = document.getElementById("roleLabel");
const occInp  = document.getElementById("occupation");
const expInp  = document.getElementById("experience");
const paceSel = document.getElementById("prefPace");
const toneSel = document.getElementById("prefTone");
const jargonCk= document.getElementById("prefJargon");

/* ---------- State ---------- */
let sessionId = null;
let pollTimer = null;
let pvqList = [];
let pvqIdx  = 0;
let prog = { total_sessions: 20, next_session: 1, completed: [], in_progress: [], all_done: false };

let preVideoDone = false;    // set true once /videos/complete returns 200
let currentStage = null;     // unified stage string, e.g. "s1.intake"
let currentFlow  = "S1";     // S1 | S2 | S3
window._lastAssistantSig = ""; // only used to warn on exact repeats

/* ---------- Helpers ---------- */
function addBubble(role, text, extraClass){
  const div = document.createElement("div");
  div.className = "bubble " + role + (extraClass ? " " + extraClass : "");
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function addEvent(text){
  const div = document.createElement("div");
  div.className = "event";
  div.textContent = "• " + text;
  eventsEl.prepend(div);
}
function setStatusBadge(val){
  const span = document.createElement("span");
  span.className = "pill";
  span.textContent = val || "—";
  if(val==="ended_early" || val==="warned") span.classList.add("warn");
  if(val==="completed") span.classList.add("done");
  if(val==="capped") span.classList.add("cap");
  statusEl.innerHTML = ""; statusEl.appendChild(span);
}
function fmt(sec){ const m = Math.floor(sec/60).toString().padStart(2,"0"); const s = Math.floor(sec%60).toString().padStart(2,"0"); return `${m}:${s}`; }
function enableComposer(on){ inputEl.disabled = !on; btnSend.disabled = !on; }
function validEmail(v){ return typeof v === "string" && v.includes("@") && v.includes("."); }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function deepReset(){
  chatEl.innerHTML = "";
  pvqList = []; pvqIdx = 0; pvqPanel.style.display = "none";
  enableComposer(false); inputEl.value = ""; btnSend.disabled = true;
  btnRecap.disabled = true;
  setStatusBadge("in_progress");
  elapsedEl.textContent = "00:00"; warnEl.textContent = "—"; capEl.textContent = "—";
}

/* ---------- NEW: Table + assistant block renderers ---------- */
function createTableEl(tbl){
  const columns = Array.isArray(tbl && tbl.columns) ? tbl.columns : [];
  const rows    = Array.isArray(tbl && tbl.rows)    ? tbl.rows    : [];

  const wrap  = document.createElement("div");
  wrap.className = "tableWrap";
  const table = document.createElement("table");

  if(columns.length){
    const thead = document.createElement("thead");
    const trh   = document.createElement("tr");
    columns.forEach(h=>{
      const th = document.createElement("th");
      th.textContent = (h==null ? "" : String(h));
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);
  }

  const tbody = document.createElement("tbody");
  rows.forEach((row)=>{
    const tr = document.createElement("tr");
    (Array.isArray(row) ? row : [row]).forEach(cell=>{
      const td = document.createElement("td");
      td.textContent = (cell==null ? "" : String(cell));
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.appendChild(table);
  return wrap;
}

/* NEW: apply UI flags (lock chat, status, progress) */
function applyUiFlags(ui){
  if(!ui) return;
  if (ui.lock_chat === true) {
    enableComposer(false);
    btnRecap.disabled = true;
  }
  if (ui.status === "complete") {
    setStatusBadge("completed");
  }
  if (typeof ui.progress_pct === "number" && ui.progress_pct >= 100) {
    addEvent("Progress: 100% complete.");
  }
}

function addAssistantBlock(text, ui, extraClass){
  const div = document.createElement("div");
  div.className = "bubble assistant" + (extraClass ? (" " + extraClass) : "");

  const p = document.createElement("div");
  p.textContent = text || "";
  div.appendChild(p);

  // Socratic reframe table (1-row, side-by-side)
  if (ui && ui.table && Array.isArray(ui.table.columns) && Array.isArray(ui.table.rows)) {
    div.appendChild(createTableEl(ui.table));
  }

  // Thought Record running table (2–3 rows, cumulative)
  if (ui && ui.table_tr && Array.isArray(ui.table_tr.columns) && Array.isArray(ui.table_tr.rows)) {
    const hdr = document.createElement("div");
    hdr.className = "hint";
    hdr.textContent = "Thought Record";
    div.appendChild(hdr);
    div.appendChild(createTableEl(ui.table_tr));
  }

  // Optional extended teaching view
  if (ui && ui.table_extended && Array.isArray(ui.table_extended.columns) && Array.isArray(ui.table_extended.rows)) {
    const hdrX = document.createElement("div");
    hdrX.className = "hint";
    hdrX.textContent = "Detail view";
    div.appendChild(hdrX);
    div.appendChild(createTableEl(ui.table_extended));
  }

  // Optional homework link in recap
  if (ui && ui.homework && ui.homework.title && ui.homework.url) {
    const hwBox = document.createElement("div");
    hwBox.style.marginTop = "8px";
    const a = document.createElement("a");
    a.href = ui.homework.url;
    a.target = "_blank";
    a.className = "link";
    a.textContent = "⬇ " + ui.homework.title;
    hwBox.appendChild(a);
    div.appendChild(hwBox);
  }

  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* ---------- Unified stage helpers ---------- */
function initialStageForSession(n){
  if(n===1) return "s1.intake";
  if(n===2) return "s2.pvq";
  return "s3.pvq";
}
function nextStageAfter(stage){
  switch(stage){
    case "s1.intake": return "s1.recap";
    case "s2.pvq": return "s2.formulation";
    case "s2.formulation": return "s2.goals";
    case "s2.goals": return "s2.homework";
    case "s2.homework": return "s2.recap";
    case "s3.pvq": return "s3.intro";
    case "s3.intro": return "s3.socratic";
    case "s3.socratic": return "s3.tr";
    case "s3.tr": return "s3.homework";
    case "s3.homework": return "s3.recap";
    default: return null;
  }
}

/* ---------- Progress gating ---------- */
async function loadProgress(){
  const email = (emailInput.value||"").trim();
  if(!validEmail(email)) return;
  try{
    const r = await fetch(`${API}/users/${encodeURIComponent(email)}/progress`, { cache: "no-store" });
    if (!r.ok) return;
    const j = await r.json();
    prog = j;
    addEvent(`Progress: completed ${j.completed.length}/${j.total_sessions}; next=${j.next_session}`);
    const requested = Number(sessionNumEl.value||1);
    if (requested > j.next_session) {
      sessionNumEl.value = j.next_session;
      addEvent(`Session locked. Reset to next available: ${j.next_session}`);
    }
  }catch(_){}
}

/* ---------- Persona ---------- */
async function loadProfile(){
  const email = (emailInput.value||"").trim();
  if(!validEmail(email)) return;
  try{
    const r = await fetch(`${API}/users/${encodeURIComponent(email)}/profile`, { cache:"no-store" });
    if(!r.ok){ Object.values(personaEls).forEach(el=>el.textContent="—"); return; }
    const j = await r.json();
    personaEls.role.textContent = j.role_label || "—";
    personaEls.occ.textContent  = j.occupation || "—";
    personaEls.exp.textContent  = j.experience_text || "—";
    personaEls.pace.textContent = (j.preferences && j.preferences.pace) || "auto";
    personaEls.tone.textContent = (j.preferences && j.preferences.tone) || "auto";
    personaEls.jargon.textContent = (j.preferences && j.preferences.jargon_ok) ? "Yes" : "No";
    roleSel.value = j.role_label || ""; occInp.value = j.occupation || ""; expInp.value = j.experience_text || "";
    paceSel.value = (j.preferences && j.preferences.pace) || ""; toneSel.value = (j.preferences && j.preferences.tone) || "";
    jargonCk.checked = !!(j.preferences && j.preferences.jargon_ok);
  }catch(_){}
}
async function saveProfile(){
  const email = (emailInput.value||"").trim();
  if(!validEmail(email)){ alert("Enter a valid email before saving profile."); return; }
  const body = {
    display_name: (nameInput.value||"").trim() || null,
    role_label: roleSel.value || null,
    occupation: occInp.value || null,
    experience_text: expInp.value || null,
    preferences: { pace: paceSel.value || undefined, tone: toneSel.value || undefined, jargon_ok: !!jargonCk.checked }
  };
  try{
    const r = await fetch(`${API}/users/${encodeURIComponent(email)}/profile`,{
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
    });
    if(!r.ok){ const e = await r.json().catch(()=>({detail:"save failed"})); throw new Error(e.detail||"Failed to save profile"); }
    addEvent("Profile saved."); drawer.style.display="none"; loadProfile();
  }catch(err){ alert(err.message||"Profile save failed"); }
}

/* ---------- Pre-session video gate ---------- */
function preFillPreVideoTitle(){
  const s = Number(sessionNumEl.value||1);
  if (s===1) document.getElementById("preVideoTitle").textContent = "Intro to Personalized GAD (watch in-app)";
  else if (s===2) document.getElementById("preVideoTitle").textContent = "CBT Triangle Introduction (watch in-app)";
  else document.getElementById("preVideoTitle").textContent = "Challenging Negative Thoughts Introduction (watch in-app)";
}
function updateStartEnabled(){
  btnStart.disabled = !(preVideoDone && validEmail(emailInput.value||""));
}
async function recordPreVideo(){
  const email = (emailInput.value||"").trim();
  if(!validEmail(email)){ alert("Enter a valid email first."); return; }
  const session_number = Number(sessionNumEl.value||1);
  try{
    const r = await fetch(`${API}/videos/complete`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email, session_number })
    });
    if(!r.ok){ const e = await r.json().catch(()=>({detail:"gate failed"})); throw new Error(e.detail||"Gate failed"); }
    preVideoDone = true;
    document.getElementById("preVideoStatus").textContent = "Recorded on server ✔";
    addEvent(`Video gate recorded for Session ${session_number}.`);
    updateStartEnabled();
  }catch(err){
    alert(err.message || "Failed to record video gate");
  }
}

/* ---------- Start / Redo ---------- */
async function startSession(){
  btnStart.disabled = true;
  try{
    const email = (emailInput.value||"").trim();
    const name  = (nameInput.value||"User").trim() || "User";
    let snum    = Number(sessionNumEl.value || 1);
    if(!validEmail(email)){ alert("Enter a valid email."); btnStart.disabled=false; return; }
    if(!preVideoDone){ alert("Please record the intro video completion first (Step 1)."); btnStart.disabled=false; return; }

    await saveProfile().catch(()=>{});
    await loadProgress();
    snum = Number(sessionNumEl.value || 1);

    const r = await fetch(`${API}/sessions/start`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        email,
        display_name: name,
        session_number: snum,
        confirm_video: true  // backend marks gate consumed
      })
    });
    if(!r.ok){ const e = await r.json().catch(()=>({detail:"start failed"})); throw new Error(e.detail||"Start failed"); }
    const j = await r.json();
    adoptSession(j.session_id, j.attempt_no, snum);
  }catch(err){ alert(err.message||"Failed to start"); }
  finally{ btnStart.disabled = false; }
}
function adoptSession(newId, attemptNo, snum){
  document.getElementById("preVideoPanel").style.display = "none";
  deepReset();
  sessionId = newId;
  emailValEl.textContent = (emailInput.value||"").trim();
  nameValEl.textContent  = (nameInput.value||"User").trim() || "User";
  sidEl.textContent = newId;

  const s = Number(snum);
  currentFlow = (s === 1 ? "S1" : s === 2 ? "S2" : "S3");

  videoPanel.style.display = "block";
  videoTitle.textContent = "Intro video recorded pre-session";
  videoStatus.textContent = "Gate consumed ✔";
  videoDoneVal.textContent = "Yes";

  // Briefing (static to avoid 404s)
  const brief = document.getElementById("briefing");
  const body  = document.getElementById("briefingBody");
  brief.style.display = "block";
  if (currentFlow === "S1") {
    body.textContent = "Goal: map your personal GAD profile. Flow: guided intake → patterns/triggers → recap.";
  } else if (currentFlow === "S2") {
    body.textContent = "Goal: build your care plan. Flow: PVQ → Case formulation → Goals → Homework → Recap.";
  } else {
    body.textContent = "Goal: challenge unhelpful thoughts. Flow: PVQ → Intro → Socratic → Thought Records → Homework → Recap.";
  }

  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(pollStatus, 1000);

  // kick off first stage
  currentStage = initialStageForSession(s);
  flowNext(currentStage);
}
async function redoAttempt(){
  if (!sessionId) return;
  btnFreshAttempt.disabled = true;
  try{
    const r = await fetch(`${API}/sessions/${sessionId}/redo`, { method:"POST" });
    if (!r.ok) {
      const e = await r.json().catch(()=>({detail:"redo failed"}));
      throw new Error(e.detail || "Failed to create a fresh attempt");
    }
    const j = await r.json();
    adoptSession(j.session_id, j.attempt_no, Number(sessionNumEl.value||1));
    addEvent(`New attempt #${j.attempt_no} started.`);
  } catch (err) {
    alert(err.message || "Could not start fresh attempt");
  } finally {
    btnFreshAttempt.disabled = false;
  }
}

/* ---------- Unified Flow ---------- */
async function flowNext(stage){
  if(!sessionId) return;
  try{
    const r = await fetch(`${API}/sessions/${sessionId}/flow/next?stage=${encodeURIComponent(stage)}`, { cache:"no-store" });
    if(!r.ok){ const e = await r.json().catch(()=>({detail:"next failed"})); addEvent("Next blocked: " + (e.detail||r.status)); return; }
    const j = await r.json();
    handleEnvelope(j.ai, stage, "next");
  }catch(_){ addEvent("Error fetching next."); }
}
async function flowAnswer(stage, payload){
  if(!sessionId) return;
  try{
    const r = await fetch(`${API}/sessions/${sessionId}/flow/answer`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ stage, ...payload })
    });
    if(!r.ok){ const e = await r.json().catch(()=>({detail:"answer failed"})); addEvent("Answer rejected: " + (e.detail||r.status)); return; }
    const j = await r.json();
    if(j.safety_interrupted){ handleEnvelope(j.ai, stage, "answer"); return; }
    handleEnvelope(j.ai, stage, "answer");
  }catch(_){ addEvent("Error sending answer."); }
}

/* ---------- PVQ (unified) ---------- */
function renderPVQList(questions){
  pvqList = Array.isArray(questions) ? questions.slice() : [];
  pvqIdx = 0;
  if(pvqList.length === 0){ pvqPanel.style.display = "none"; return; }
  pvqPanel.style.display = "block";
  renderPVQItem();
}
function renderPVQItem(){
  const q = pvqList[pvqIdx];
  pvqProg.textContent = `Q${pvqIdx+1}/${pvqList.length}`;
  pvqQEl.textContent = (q && q.prompt) ? q.prompt : "—";
  pvqAns.value = "";
  pvqPrev.disabled = (pvqIdx===0);
  pvqNext.textContent = (pvqIdx===pvqList.length-1) ? "Finish" : "Next";
}
pvqPrev.onclick = ()=>{ if(pvqIdx>0){ pvqIdx--; renderPVQItem(); } };
pvqNext.onclick = async ()=>{
  const stage = currentStage; // s2.pvq or s3.pvq
  const q = pvqList[pvqIdx];
  const ans = pvqAns.value.trim();
  if(!ans){ alert("Please answer before continuing."); return; }
  addBubble("user", ans);
  await flowAnswer(stage, { qid: q.id, answer: ans });

  if(pvqIdx < pvqList.length-1){ pvqIdx++; renderPVQItem(); }
  else{
    pvqPanel.style.display="none";
    const next = nextStageAfter(stage);
    if(next){ currentStage = next; flowNext(currentStage); }
  }
};

/* ---------- Envelope handling ---------- */
let confirmRow = null;
function renderConfirmRow(){
  removeConfirmRow();
  confirmRow = document.createElement("div");
  confirmRow.className = "quickRow";
  const yes = document.createElement("button");
  const no  = document.createElement("button");
  yes.textContent = "Yes";
  no.textContent  = "No";
  yes.className = "primary";
  no.className  = "ghost";
  confirmRow.append(yes, no);
  document.querySelector(".composer").appendChild(confirmRow);

  yes.onclick = () => sendUserText("Yes");
  no.onclick  = () => sendUserText("No");
}
function removeConfirmRow(){
  if (confirmRow && confirmRow.parentNode) confirmRow.parentNode.removeChild(confirmRow);
  confirmRow = null;
}

function handleEnvelope(ai, stage, source){
  if(!ai || typeof ai!=="object"){ addEvent("Bad AI envelope"); return; }

  // Safety pause
  if (ai.type === "safety_pause") {
    const line = ai.acknowledgement || "I’m here with you. Are you in immediate danger right now?";
    addAssistantBlock(line, ai.ui, "danger");
    applyUiFlags(ai.ui);
    enableComposer(false);
    btnRecap.disabled = false;
    setStatusBadge("ended_early");
    return;
  }

  // PVQ
  if (ai.type === "pvq" && ai.ui && ai.ui.pvq && Array.isArray(ai.ui.pvq.questions)) {
    addAssistantBlock(ai.acknowledgement || "Let's do a few quick post-video questions.", ai.ui);
    applyUiFlags(ai.ui);
    renderPVQList(ai.ui.pvq.questions);
    return;
  }

  // Recap (supports optional ui.table + ui.homework; locks chat if provided)
  if (ai.type === "recap") {
    const paras = (ai.recap && ai.recap.paragraphs) ? ai.recap.paragraphs.join("\n\n") : "(summary)";
    addAssistantBlock(paras, ai.ui);
    applyUiFlags(ai.ui);
    enableComposer(false);
    btnRecap.disabled = true;
    setStatusBadge("completed");
    return;
  }

  // Question / Ack
  if (ai.type === "question" || ai.type === "ack") {
    const text = ai.prompt || ai.acknowledgement || "(question)";
    const sig  = text.replace(/\s+/g," ").trim().toLowerCase();

    if (window._lastAssistantSig && window._lastAssistantSig === sig) {
      addEvent("Assistant repeated the same prompt.");
    }
    addAssistantBlock(text, ai.ui);
    applyUiFlags(ai.ui);
    window._lastAssistantSig = sig;

    if (ai.ui && ai.ui.confirm_required === true) {
      enableComposer(false);
      renderConfirmRow();
    } else {
      removeConfirmRow();
      enableComposer(true);
    }

    if (ai.done === true) {
      const next = nextStageAfter(stage);
      if (next) { currentStage = next; flowNext(currentStage); }
    }
    return;
  }

  // Fallback
  addAssistantBlock(JSON.stringify(ai, null, 2));
}

/* ---------- Send chat ---------- */
async function sendUserText(text){
  if(!sessionId) return;
  const msg = (text != null ? String(text) : (inputEl.value||"").trim());
  if(!msg) return;
  addBubble("user", msg);
  enableComposer(false); removeConfirmRow(); inputEl.value = "";
  await flowAnswer(currentStage, { message: msg });
}
btnSend.addEventListener("click", ()=> sendUserText());

/* ---------- Recap button ---------- */
btnRecap.addEventListener("click", ()=>{
  if(!sessionId) return;
  const s = Number(sessionNumEl.value||1);
  const stage = (s===1 ? "s1.recap" : s===2 ? "s2.recap" : "s3.recap");
  currentStage = stage;
  flowNext(stage);
});

/* ---------- Poll status ---------- */
async function pollStatus(){
  if(!sessionId) return;
  try{
    const r = await fetch(`${API}/sessions/${sessionId}/status`, { cache:"no-store" });
    if(!r.ok) return;
    const j = await r.json();
    const t = j.timer||{};
    elapsedEl.textContent = fmt(t.elapsed||0);
    warnEl.textContent = t.warn ? "⚠ yes" : "no";
    capEl.textContent  = t.cap  ? "⏱ yes" : "no";
    setStatusBadge(j.status);
    videoDoneVal.textContent = j.video_completed ? "Yes" : "No";
    if (j.video_completed && videoStatus.textContent !== "Gate consumed ✔") videoStatus.textContent = "Gate consumed ✔";

    const cappedOrEnded = (j.status === "ended_early") || (t.cap === true);
    btnFreshAttempt.style.display = cappedOrEnded ? "inline-block" : "none";

    if(t.cap && j.status!=="completed"){
      addAssistantBlock("We’ve reached the 30-minute limit. You can generate a recap with what we have, or start a fresh attempt.", null, "danger");
      enableComposer(false);
      btnRecap.disabled = false;
    }
  }catch(_){}
}

/* ---------- Wire up ---------- */
document.getElementById("apiBase").addEventListener("change", (e)=> { API = e.target.value.replace(/\/$/, ""); loadProfile(); loadProgress(); });
document.getElementById("btnProfile").addEventListener("click", ()=>{ drawer.style.display="block"; loadProfile(); });
document.getElementById("btnCloseProfile").addEventListener("click", ()=> drawer.style.display="none");
document.getElementById("btnSaveProfile").addEventListener("click", saveProfile);
document.getElementById("btnProfileDefaults").addEventListener("click", ()=>{
  const r = (roleSel.value||"").toLowerCase();
  if(["doctor","nurse","clinician","therapist"].includes(r)){ paceSel.value=""; toneSel.value="professional_warm"; jargonCk.checked=true; }
  else if(["engineer","researcher"].includes(r)){ paceSel.value="concise"; toneSel.value="warm_plain"; jargonCk.checked=true; }
  else if(["student","parent","teacher"].includes(r)){ paceSel.value="standard"; toneSel.value="warm_plain"; jargonCk.checked=false; }
  else { paceSel.value=""; toneSel.value=""; jargonCk.checked=false; }
});

document.getElementById("btnPreVideoDone").addEventListener("click", recordPreVideo);
document.getElementById("btnStart").addEventListener("click", startSession);
document.getElementById("btnFreshAttempt").addEventListener("click", redoAttempt);

emailInput.addEventListener("blur", ()=>{ loadProfile(); loadProgress(); updateStartEnabled(); });
emailInput.addEventListener("input", updateStartEnabled);
nameInput.addEventListener("input", updateStartEnabled);
sessionNumEl.addEventListener("change", ()=>{
  const v = Number(sessionNumEl.value||1);
  preFillPreVideoTitle();
  if (prog && v > prog.next_session) {
    alert(`Session ${v} is locked. Next available is Session ${prog.next_session}.`);
    sessionNumEl.value = prog.next_session;
    preFillPreVideoTitle();
  }
  // gate must be recorded again for new session number
  preVideoDone = false;
  document.getElementById("preVideoStatus").textContent = "Required before starting the session.";
  updateStartEnabled();
});
inputEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); btnSend.click(); }});

/* init */
preFillPreVideoTitle();
updateStartEnabled();
</script>
</body>
</html>
